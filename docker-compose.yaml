services:
  # =========================================
  # 1. ROS 1 底層控制 (control)
  # =========================================
  control:
    platform: ${ARCH:-linux/amd64}
    build:
      context: ./control
      dockerfile: Dockerfile
    image: agx_ros/control
    container_name: control
    network_mode: host
    # Host 模式下 ports 無效，直接使用本機端口
    # ports: ... 
    privileged: true
    environment:
      # [關鍵修改] Host 模式下，容器名稱無法解析，必須用 localhost
      - ROS_MASTER_URI=http://localhost:11311
      - ROS_HOSTNAME=localhost
      - DISPLAY=${DISPLAY}
      - XAUTHORITY=/tmp/.docker.xauth
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/.docker.xauth:/tmp/.docker.xauth:rw
      - /home/systemlabagx/disk/Lun_RL_ws/src/six_wheels_teleop:/root/keyboard_control_ws/src/six_wheels_teleop
    entrypoint: ["/root/entrypoint.sh"]
    tty: true
    stdin_open: true

  # =========================================
  # 2. ROS 1 <-> ROS 2 橋樑 (Bridge)
  # =========================================
  bridge:
    platform: ${ARCH:-linux/amd64}
    build:
      context: ./bridge
      dockerfile: Dockerfile
    image: agx_ros/bridge:latest
    container_name: bridge
    restart: on-failure
    network_mode: host
    environment:
      - ROS_MASTER_URI=http://localhost:11311
      - ROS_HOSTNAME=localhost
      - ROS_DOMAIN_ID=0     
    tty: true
    stdin_open: true
    command: >
      bash -c "source /opt/ros/noetic/setup.bash &&
               source /opt/ros/foxy/setup.bash &&
               ros2 run ros1_bridge dynamic_bridge --bridge-all-1to2-topics --bridge-all-2to1-topics"

  # =========================================
  # 3. ROS 2 高階規劃 (Planning)
  # =========================================
  planning:
    platform: ${ARCH:-linux/amd64}
    build:
      context: ./planning
      dockerfile: Dockerfile
    image: agx_ros/planning:latest
    container_name: planning
    network_mode: host
    privileged: true
    environment:
      - ROS_DOMAIN_ID=0
      - ROS_HOSTNAME=localhost
      - DISPLAY=${DISPLAY}
      - XAUTHORITY=/tmp/.docker.xauth
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/.docker.xauth:/tmp/.docker.xauth:rw
    tty: true
    stdin_open: true

  # =========================================
  # 4. 資料視覺化 (Foxglove)
  # =========================================
  visualization:
    platform: ${ARCH:-linux/amd64}
    build:
      context: ./foxglove
      dockerfile: Dockerfile
    image: agx_ros/visualization:latest
    container_name: foxglove
    network_mode: host
    environment:
      - ROS_DOMAIN_ID=0
      - ROS_HOSTNAME=localhost
    restart: unless-stopped
    command: >
      /bin/bash -c "source /opt/ros/humble/setup.bash &&
      ros2 run foxglove_bridge foxglove_bridge --ros-args -p send_buffer_limit:=100000000"
      
  # =========================================
  # 5. Isaac ROS 視覺加速服務
  # =========================================
  isaac_ros:
    build:
      context: ./vlm
      dockerfile: Dockerfile
    image: agx_ros/isaac_ros:latest
    container_name: isaac_ros
    profiles: ["agx_mode"]
    network_mode: host
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - ROS_DOMAIN_ID=0
      - ROS_HOSTNAME=localhost
      - ISAAC_ROS_WS=/workspaces/isaac_ros-dev
      - DISPLAY=${DISPLAY}
      - XAUTHORITY=/tmp/.docker.xauth
    privileged: true
    runtime: nvidia
    volumes:
      - /dev:/dev
      - /run/jtop.stats.sock:/run/jtop.stats.sock
      - /etc/localtime:/etc/localtime:ro
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/.docker.xauth:/tmp/.docker.xauth:rw
      - /home/systemlabagx/disk/workspaces/isaac_ros-dev:/workspaces/isaac_ros-dev
    stdin_open: true
    tty: true
    command: /bin/bash -c "while true; do sleep 3600; done"

  # =========================================
  # 6. Nano LLM 服務 (含 ROS 2 Humble)
  # 參考: https://github.com/dusty-nv/jetson-containers/tree/master/packages/llm/nano_llm
  # 注意：container_name 改為 nanollm_compose 以避免與手動建立的 nanollm 容器衝突
  # =========================================
  nanollm:
    build:
      context: ./nanollm
      dockerfile: Dockerfile
    image: agx_ros/nanollm:latest
    container_name: nanollm
    runtime: nvidia
    network_mode: host
    ipc: host
    shm_size: "8g"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
      - ROS_DOMAIN_ID=0
      - ROS_HOSTNAME=localhost
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - DISPLAY=${DISPLAY}
      - XAUTHORITY=/tmp/.docker.xauth
      - PULSE_SERVER=unix:/run/user/1000/pulse/native
    privileged: true
    volumes:
      # jetson-containers 預設 mounts
      - /tmp/argus_socket:/tmp/argus_socket
      - /etc/enctune.conf:/etc/enctune.conf
      - /etc/nv_tegra_release:/etc/nv_tegra_release
      - /tmp/nv_jetson_model:/tmp/nv_jetson_model
      - /var/run/dbus:/var/run/dbus
      - /var/run/avahi-daemon/socket:/var/run/avahi-daemon/socket
      - /var/run/docker.sock:/var/run/docker.sock
      # 時區與音訊
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /run/user/1000/pulse:/run/user/1000/pulse
      # X11 顯示
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/.docker.xauth:/tmp/.docker.xauth:rw
      # jtop 監控
      - /run/jtop.sock:/run/jtop.sock
      # 資料與模型目錄
      - /home/systemlabagx/disk/workspaces/data:/data
      - /home/systemlabagx/disk/workspaces/data/nanollm_models:/data/models
      # 與 Isaac ROS 共用 workspace
      - /home/systemlabagx/disk/workspaces:/workspaces
    devices:
      - /dev/snd
      - /dev/bus/usb
      - /dev/video0
      - /dev/video1
      - /dev/video2
      - /dev/video3
      - /dev/video4
      - /dev/video5
    working_dir: /data
    stdin_open: true
    tty: true
    command: ["bash", "-lc", "sleep infinity"]

# [移除] 不需要 networks 定義
# networks:
#   ros_net:
#     driver: bridge